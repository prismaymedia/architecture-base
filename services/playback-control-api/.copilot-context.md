# Inventory API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **gestionar el inventario y disponibilidad de productos** en el sistema de e-commerce.

## Dominio

### Entidades Principales
- **Product**: Información básica del producto
- **Stock**: Cantidad disponible por producto
- **Reservation**: Reservas temporales de stock
- **StockMovement**: Historial de movimientos de inventario

### Agregados
- Stock (raíz del agregado)
  - Reservations (parte del agregado)
  - StockMovements (historial)

## Responsabilidades

### Commands (Escritura)
- Reservar stock para un pedido
- Confirmar salida de stock
- Liberar reservas (cuando se cancela pedido)
- Ajustar inventario manualmente
- Agregar nuevo producto al inventario

### Queries (Lectura)
- Consultar disponibilidad de productos
- Obtener stock actual
- Listar productos con bajo stock
- Obtener historial de movimientos

## Eventos

### Eventos Publicados

#### InventoryReservedEvent
**Cuándo**: Cuando se reserva stock exitosamente para un pedido
**Payload**:
```
- OrderId: Guid
- ReservationId: Guid
- Items: List<ReservedItem>
  - ProductId: Guid
  - Quantity: int
  - ReservedAt: DateTime
- ExpiresAt: DateTime (reserva expira en 15 minutos)
```
**Consumidores**: Orders API, Payments API

#### InventoryReservationFailedEvent
**Cuándo**: Cuando no hay suficiente stock para reservar
**Payload**:
```
- OrderId: Guid
- Reason: string (Out of stock / Insufficient quantity)
- UnavailableProducts: List<ProductId>
```
**Consumidores**: Orders API

#### InventoryReleasedEvent
**Cuándo**: Cuando se libera una reserva (por cancelación o expiración)
**Payload**:
```
- OrderId: Guid
- ReservationId: Guid
- ReleasedAt: DateTime
- Reason: string
```
**Consumidores**: Orders API

#### LowStockEvent
**Cuándo**: Cuando el stock de un producto cae por debajo del umbral
**Payload**:
```
- ProductId: Guid
- CurrentStock: int
- Threshold: int
- AlertedAt: DateTime
```
**Consumidores**: Notifications API, (eventualmente) Purchasing API

#### OutOfStockEvent
**Cuándo**: Cuando un producto se queda sin stock
**Payload**:
```
- ProductId: Guid
- OutOfStockAt: DateTime
```
**Consumidores**: Notifications API

### Eventos Consumidos

#### OrderCreatedEvent (de Orders API)
**Acción**: Intentar reservar stock para los items del pedido
**Handler**: OrderCreatedEventHandler
**Flujo**:
1. Validar disponibilidad de todos los productos
2. Si hay stock: Reservar y publicar InventoryReservedEvent
3. Si no hay stock: Publicar InventoryReservationFailedEvent

#### OrderCancelledEvent (de Orders API)
**Acción**: Liberar reserva de stock
**Handler**: OrderCancelledEventHandler

#### OrderShippedEvent (de Orders API)
**Acción**: Confirmar salida definitiva de stock (quitar de reserva a stock físico)
**Handler**: OrderShippedEventHandler

#### PaymentRejectedEvent (de Payments API)
**Acción**: Liberar reserva automáticamente
**Handler**: PaymentRejectedEventHandler

## Reglas de Negocio

1. Las reservas expiran después de 15 minutos si no se confirman
2. No se puede reservar más stock del disponible
3. El stock nunca puede ser negativo
4. Los ajustes manuales requieren aprobación y son auditados
5. Alerta de low stock cuando queda menos del 20% del stock mínimo
6. Una reserva expirada libera automáticamente el stock

## Dependencias Externas

### Base de Datos
- **InventoryDB** (SQL Server)
- Tablas: Products, Stock, Reservations, StockMovements

### Event Bus
- RabbitMQ / Azure Service Bus

### Background Jobs
- Job para liberar reservas expiradas (ejecuta cada minuto)
- Job para detectar low stock (ejecuta cada hora)

## Estructura del Proyecto

```
inventory-api/
├── src/
│   ├── api/
│   │   ├── Controllers/         # Endpoints REST
│   │   └── Middleware/
│   ├── application/
│   │   ├── Commands/            # Reserve, Release, Adjust commands
│   │   ├── Queries/             # Availability queries
│   │   ├── Handlers/            # Command & Event handlers
│   │   └── Services/            # StockService, ReservationService
│   ├── domain/
│   │   ├── Entities/            # Product, Stock, Reservation
│   │   ├── ValueObjects/        # Quantity, StockLevel
│   │   ├── Repositories/        # Interfaces
│   │   └── Events/              # Domain events
│   └── infrastructure/
│       ├── Persistence/         # EF Core DbContext
│       ├── EventBus/            # Event publishing/consuming
│       ├── BackgroundJobs/      # Hangfire jobs
│       └── Configuration/
└── tests/
    ├── unit/
    ├── integration/
    └── fixtures/
```

## Patrones Implementados

- **CQRS**: Separación de Commands y Queries
- **Optimistic Locking**: Para prevenir race conditions en reservas
- **Saga Participant**: Participa en Saga de creación de orden
- **Compensation Logic**: Liberar reservas cuando falla transacción

## Configuración

### Connection Strings
- InventoryDB: Conexión a SQL Server

### Event Bus Settings
- Queue names: `inventory.*`
- Exchange: `inventory-exchange`

### Background Jobs
- Hangfire para jobs recurrentes
- Redis para coordinación distribuida

### Stock Thresholds
- Low stock threshold: 20% del stock mínimo
- Reservation expiration: 15 minutos

## Consideraciones Importantes

### Concurrencia
- Usar versioning optimista en Stock entity
- Locks pesimistas para operaciones críticas
- Transactions para reservas atómicas

### Idempotencia
- Usar OrderId como deduplication key
- Verificar si la reserva ya existe antes de crear
- Idempotent handlers para todos los eventos

### Resiliencia
- Retry con exponential backoff
- Circuit breaker para event publishing
- Fallback: Marcar reserva como "pending review"

### Auditoría
- Todos los movimientos de stock son auditados
- StockMovements table mantiene historial completo
- Incluir UserId en ajustes manuales

### Performance
- Índices en ProductId, OrderId
- Caché de disponibilidad (invalidar en cambios)
- Batch processing para múltiples items

## Testing

### Unit Tests
- Stock reservation logic
- Business rules (no negative stock)
- Expiration logic

### Integration Tests
- Complete reservation flow
- Event handler integration
- Concurrent reservation scenarios

### Performance Tests
- Concurrent reservations del mismo producto
- Bulk stock checks

## Endpoints API

### POST /api/inventory/reserve
Reservar stock (llamada interna via eventos)

### POST /api/inventory/release
Liberar reserva

### GET /api/inventory/products/{id}/availability
Consultar disponibilidad de producto

### GET /api/inventory/products
Listar productos con stock

### POST /api/inventory/adjust
Ajuste manual de inventario (requiere autorización)

### GET /api/inventory/low-stock
Listar productos con stock bajo

### GET /api/inventory/movements
Historial de movimientos de stock

## Background Jobs

### ReleaseExpiredReservationsJob
- **Frecuencia**: Cada minuto
- **Acción**: Buscar reservas expiradas y liberarlas
- **Event**: Publicar InventoryReleasedEvent

### CheckLowStockJob
- **Frecuencia**: Cada hora
- **Acción**: Verificar productos con stock bajo
- **Event**: Publicar LowStockEvent si aplica

## Métricas y Observabilidad

- Contador de reservas exitosas
- Contador de reservas fallidas
- Stock disponible por producto
- Tiempo promedio de reserva
- Tasa de expiraciones de reservas
- Alertas de low stock

## Escenarios de Compensación

### Saga Compensación: Order Creation Failed

```
1. Inventory reservó stock
2. Payment falló
3. Inventory recibe PaymentRejectedEvent
4. Libera reserva
5. Publica InventoryReleasedEvent
```

## Referencias

- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Saga Pattern Guide](../../docs/guides/saga-pattern.md)
- [Concurrency Patterns](../../docs/guides/concurrency.md)
