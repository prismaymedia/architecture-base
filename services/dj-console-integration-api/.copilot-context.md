# Notifications API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **enviar notificaciones a usuarios y sistemas externos** a través de múltiples canales (email, SMS, push, webhooks).

## Dominio

### Entidades Principales
- **Notification**: Representa una notificación enviada
- **NotificationTemplate**: Plantillas para emails/SMS
- **NotificationPreference**: Preferencias del usuario
- **DeliveryLog**: Log de entregas exitosas/fallidas

### Agregados
- Notification (raíz del agregado)
  - DeliveryAttempts (intentos de envío)

## Responsabilidades

### Commands (Escritura)
- Enviar email
- Enviar SMS
- Enviar push notification
- Enviar webhook a sistema externo
- Actualizar preferencias de usuario
- Crear/actualizar templates

### Queries (Lectura)
- Consultar historial de notificaciones
- Obtener templates disponibles
- Consultar preferencias de usuario
- Ver estadísticas de entrega

## Eventos

### Eventos Publicados

#### NotificationSentEvent
**Cuándo**: Cuando se envía una notificación exitosamente
**Payload**:
```
- NotificationId: Guid
- UserId: Guid
- Channel: string (Email/SMS/Push/Webhook)
- Type: string (OrderConfirmation, PaymentApproved, etc.)
- SentAt: DateTime
```
**Consumidores**: Analytics (para tracking)

#### NotificationFailedEvent
**Cuándo**: Cuando falla el envío de una notificación (después de reintentos)
**Payload**:
```
- NotificationId: Guid
- UserId: Guid
- Channel: string
- Reason: string
- FailedAt: DateTime
- AttemptsCount: int
```
**Consumidores**: Support System (para seguimiento manual)

### Eventos Consumidos

#### OrderCreatedEvent (de Orders API)
**Acción**: Enviar email de confirmación de pedido
**Handler**: OrderCreatedEventHandler
**Template**: OrderCreatedTemplate
**Channels**: Email, Push (si está habilitado)

#### OrderConfirmedEvent (de Orders API)
**Acción**: Enviar confirmación de pago y pedido
**Handler**: OrderConfirmedEventHandler
**Template**: OrderConfirmedTemplate
**Channels**: Email, SMS (opcional)

#### OrderCancelledEvent (de Orders API)
**Acción**: Notificar cancelación de pedido
**Handler**: OrderCancelledEventHandler
**Template**: OrderCancelledTemplate
**Channels**: Email

#### OrderShippedEvent (de Orders API)
**Acción**: Enviar información de envío y tracking
**Handler**: OrderShippedEventHandler
**Template**: OrderShippedTemplate
**Channels**: Email, SMS, Push

#### PaymentApprovedEvent (de Payments API)
**Acción**: Enviar confirmación de pago
**Handler**: PaymentApprovedEventHandler
**Template**: PaymentApprovedTemplate
**Channels**: Email

#### PaymentRejectedEvent (de Payments API)
**Acción**: Notificar rechazo de pago
**Handler**: PaymentRejectedEventHandler
**Template**: PaymentRejectedTemplate
**Channels**: Email, Push

#### RefundProcessedEvent (de Payments API)
**Acción**: Notificar reembolso procesado
**Handler**: RefundProcessedEventHandler
**Template**: RefundProcessedTemplate
**Channels**: Email

#### LowStockEvent (de Inventory API)
**Acción**: Alertar a equipo de compras
**Handler**: LowStockEventHandler
**Template**: LowStockAlertTemplate
**Channels**: Email (interno), Webhook (sistema de compras)

## Reglas de Negocio

1. Respetar preferencias de usuario (no enviar si ha optado out)
2. Máximo 3 intentos de envío por notificación
3. No enviar duplicados (idempotencia por evento)
4. Rate limiting: máximo 5 emails por usuario por hora
5. Horario de envío: SMS solo entre 8am-10pm (hora local)
6. Templates en múltiples idiomas según preferencia de usuario
7. Webhooks con autenticación HMAC

## Dependencias Externas

### Base de Datos
- **NotificationsDB** (SQL Server)
- Tablas: Notifications, Templates, Preferences, DeliveryLog

### Event Bus
- RabbitMQ / Azure Service Bus

### External Services
- **SendGrid / AWS SES**: Para envío de emails
- **Twilio**: Para SMS
- **Firebase Cloud Messaging**: Para push notifications
- **HTTP Client**: Para webhooks

### Template Engine
- Razor / Liquid templates
- Soporte para variables dinámicas
- Previsualización de templates

## Estructura del Proyecto

```
notifications-api/
├── src/
│   ├── api/
│   │   ├── Controllers/         # Endpoints REST
│   │   └── Middleware/
│   ├── application/
│   │   ├── Commands/            # Send notification commands
│   │   ├── Queries/             # History queries
│   │   ├── Handlers/            # Event handlers
│   │   └── Services/            # NotificationService
│   ├── domain/
│   │   ├── Entities/            # Notification, Template
│   │   ├── ValueObjects/        # Channel, NotificationType
│   │   ├── Repositories/        # Interfaces
│   │   └── Events/              # Domain events
│   └── infrastructure/
│       ├── Persistence/         # EF Core DbContext
│       ├── EventBus/            # Event consuming
│       ├── Channels/            # Email, SMS, Push providers
│       │   ├── INotificationChannel.cs
│       │   ├── EmailChannel.cs
│       │   ├── SmsChannel.cs
│       │   ├── PushChannel.cs
│       │   └── WebhookChannel.cs
│       ├── Templates/           # Template engine
│       └── Configuration/
└── tests/
    ├── unit/
    ├── integration/
    └── fixtures/
```

## Patrones Implementados

- **Strategy Pattern**: Para múltiples canales de notificación
- **Template Method**: Para proceso de envío
- **Observer Pattern**: Escuchar eventos de otros servicios
- **Retry Pattern**: Con exponential backoff
- **Circuit Breaker**: Para servicios externos

## Configuración

### Connection Strings
- NotificationsDB: Conexión a SQL Server

### Event Bus Settings
- Queue names: `notifications.*`
- Exchange: `notifications-exchange`

### Channel Providers
```
SendGrid:
  - ApiKey: (secret)
  - FromEmail: noreply@company.com
  - FromName: Company Name

Twilio:
  - AccountSid: (secret)
  - AuthToken: (secret)
  - PhoneNumber: +1234567890

Firebase:
  - ProjectId: (secret)
  - PrivateKey: (secret)
```

### Rate Limiting
- Emails: 5 por usuario por hora
- SMS: 3 por usuario por día
- Push: 10 por usuario por hora

## Consideraciones Importantes

### Idempotencia
- Usar EventId como deduplication key
- No enviar duplicados del mismo evento
- Cache de notificaciones enviadas (últimas 24 horas)

### Resiliencia
- Circuit breaker para cada proveedor externo
- Retry con exponential backoff (1s, 5s, 15s)
- Fallback: Usar canal alternativo si primario falla
- Queue de reintentos para fallos temporales

### Performance
- Envío asíncrono de todas las notificaciones
- Batch sending cuando sea posible
- Background jobs para procesar cola
- Priorización de notificaciones críticas

### Privacidad
- GDPR compliance
- Opt-out respetado siempre
- Anonimización de datos después de 90 días
- No almacenar contenido completo de mensajes

### Templates
- Cache de templates compilados
- Validación de sintaxis antes de guardar
- Versionado de templates
- A/B testing support (futuro)

## Testing

### Unit Tests
- Template rendering
- Channel selection logic
- Preference checking
- Rate limiting

### Integration Tests
- Full notification flow
- Event handler integration
- Provider mocking

### Contract Tests
- Event schema validation
- Webhook payload validation

## Endpoints API

### POST /api/notifications/send
Enviar notificación manual (admin)

### GET /api/notifications
Historial de notificaciones (con paginación)

### GET /api/notifications/{id}
Detalle de notificación específica

### GET /api/notifications/preferences/{userId}
Obtener preferencias de usuario

### PUT /api/notifications/preferences/{userId}
Actualizar preferencias

### GET /api/notifications/templates
Listar templates disponibles

### POST /api/notifications/templates
Crear nuevo template (admin)

### PUT /api/notifications/templates/{id}
Actualizar template (admin)

### POST /api/notifications/test
Enviar notificación de prueba (admin)

## Background Jobs

### ProcessNotificationQueueJob
- **Frecuencia**: Continuo (polling cada 5s)
- **Acción**: Procesar cola de notificaciones pendientes

### RetryFailedNotificationsJob
- **Frecuencia**: Cada 15 minutos
- **Acción**: Reintentar notificaciones fallidas

### CleanupOldNotificationsJob
- **Frecuencia**: Diario
- **Acción**: Archivar/eliminar notificaciones antiguas (>90 días)

## Templates Disponibles

### Order Templates
- `OrderCreatedTemplate`: Confirmación inicial
- `OrderConfirmedTemplate`: Confirmación de pago
- `OrderShippedTemplate`: Información de envío
- `OrderCancelledTemplate`: Notificación de cancelación
- `OrderDeliveredTemplate`: Confirmación de entrega

### Payment Templates
- `PaymentApprovedTemplate`: Confirmación de pago
- `PaymentRejectedTemplate`: Rechazo de pago
- `RefundProcessedTemplate`: Reembolso procesado

### Internal Templates
- `LowStockAlertTemplate`: Alerta de bajo stock
- `SystemAlertTemplate`: Alertas del sistema

### Estructura de Template

```liquid
{% raw %}
Subject: {{ Subject }}

Hello {{ CustomerName }},

Your order #{{ OrderId }} has been {{ Status }}.

{{ CustomMessage }}

Thank you,
{{ CompanyName }}
{% endraw %}
```

## Métricas y Observabilidad

- Tasa de entrega por canal
- Tiempo promedio de envío
- Tasa de apertura de emails (si tracking habilitado)
- Tasa de fallos por proveedor
- Volumen de notificaciones por tipo
- Rate limiting hits

## Retry Strategy

### Email
1. Intento inmediato
2. Retry después de 1 minuto
3. Retry después de 5 minutos
4. Dead letter queue

### SMS
1. Intento inmediato
2. Retry después de 5 minutos
3. Dead letter queue

### Push
1. Intento inmediato
2. Retry después de 30 segundos
3. Dead letter queue

### Webhook
1. Intento inmediato
2. Retry después de 1 minuto
3. Retry después de 10 minutos
4. Dead letter queue

## Monitoreo

- Alertas de tasa de fallos > 10%
- Alertas de latencia > 30s
- Monitoreo de quotas de proveedores
- Health checks de todos los proveedores

## Compliance

- **GDPR**: Opt-out mechanism, data retention
- **CAN-SPAM**: Unsubscribe link en emails
- **TCPA**: Consent para SMS
- **CCPA**: Data deletion requests

## Referencias

- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Template Guide](../../docs/guides/notification-templates.md)
- [Privacy Policy](../../docs/guides/privacy.md)
