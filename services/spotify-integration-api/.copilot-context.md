# Spotify Integration API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **gestionar toda la integración con Spotify Web API**, incluyendo autenticación OAuth, gestión de tokens, y comunicación con endpoints de Spotify.

## Dominio

### Entidades Principales
- **SpotifyUser**: Usuario autenticado con Spotify Premium
- **SpotifyToken**: Access token y refresh token de OAuth
- **SpotifyDevice**: Dispositivos Spotify disponibles para reproducción
- **SpotifyTrack**: Metadata de tracks (ID, URI, nombre, artista, álbum, duración)
- **SpotifyPlaylist**: Playlists del usuario

### Agregados
- SpotifyUser (raíz del agregado)
  - SpotifyTokens (parte del agregado)
  - SpotifyDevices (colección)
  - SpotifyPreferences (configuración)

## Responsabilidades

### Commands (Escritura)
- Autenticar usuario con Spotify OAuth 2.0
- Renovar tokens expirados
- Desautenticar usuario (revoke tokens)
- Actualizar preferencias de usuario

### Queries (Lectura)
- Obtener dispositivos disponibles del usuario
- Buscar tracks, artistas, álbumes
- Obtener playlists del usuario
- Obtener metadata de track (BPM, key, audio features)
- Obtener estado de autenticación del usuario

## Eventos

### Eventos Publicados

#### UserAuthenticatedEvent
**Cuándo**: Usuario completa autenticación OAuth con Spotify
**Payload**:
```json
{
  "userId": "string",
  "spotifyUserId": "string",
  "accessToken": "encrypted_string",
  "refreshToken": "encrypted_string",
  "expiresAt": "ISO8601",
  "scopes": ["user-read-playback-state", "user-modify-playback-state"],
  "authenticatedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API, Sync Service

#### TokenRefreshedEvent
**Cuándo**: Access token es renovado automáticamente
**Payload**:
```json
{
  "userId": "string",
  "newAccessToken": "encrypted_string",
  "expiresAt": "ISO8601",
  "refreshedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API

#### AuthenticationFailedEvent
**Cuándo**: Autenticación o renovación de token falla
**Payload**:
```json
{
  "userId": "string",
  "errorCode": "string",
  "errorMessage": "string",
  "failedAt": "ISO8601"
}
```
**Consumidores**: Frontend, Sync Service

#### DevicesUpdatedEvent
**Cuándo**: Lista de dispositivos Spotify cambia
**Payload**:
```json
{
  "userId": "string",
  "devices": [
    {
      "id": "string",
      "name": "string",
      "type": "Computer|Smartphone|Speaker|TV|etc",
      "isActive": "boolean",
      "volume": "number"
    }
  ],
  "updatedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API, Frontend

### Eventos Consumidos

#### PlaybackCommandEvent (de Playback Control API)
**Acción**: Ejecutar comando de reproducción en Spotify API
**Handler**: PlaybackCommandHandler

#### DeviceRefreshRequestedEvent (de Frontend o Playback Control API)
**Acción**: Actualizar lista de dispositivos desde Spotify
**Handler**: DeviceRefreshHandler

## Reglas de Negocio

1. Solo usuarios con Spotify Premium pueden autenticarse (validar en OAuth)
2. Tokens deben renovarse automáticamente 5 minutos antes de expiración
3. Máximo 3 reintentos para renovación de token antes de requerir re-autenticación
4. Todos los tokens se almacenan encriptados en GCP Secret Manager
5. Rate limiting: Respetar límite de 180 requests/min/user de Spotify
6. Si usuario revoca acceso en Spotify, eliminar tokens localmente

## Dependencias Externas

### Base de Datos
- **Cloud SQL (PostgreSQL)**: SpotifyIntegrationDB
- Tablas: spotify_users, spotify_tokens, spotify_devices, token_refresh_log

### Spotify Web API
- **OAuth 2.0 Endpoints**:
  - Authorization: `https://accounts.spotify.com/authorize`
  - Token: `https://accounts.spotify.com/api/token`
- **API Endpoints**:
  - Devices: `GET /v1/me/player/devices`
  - Search: `GET /v1/search`
  - Audio Features: `GET /v1/audio-features/{id}`
  - Playlists: `GET /v1/users/{user_id}/playlists`

### GCP Services
- **Secret Manager**: Almacenamiento seguro de tokens
- **Cloud Pub/Sub**: Publicación de eventos
- **Cloud Logging**: Structured logging

### Bibliotecas
- **spotipy**: Wrapper de Spotify Web API
- **google-cloud-secret-manager**: Gestión de secrets
- **google-cloud-pubsub**: Event publishing

## Estructura del Proyecto

```
spotify-integration-api/
├── app/
│   ├── api/
│   │   ├── routers/              # FastAPI routers
│   │   │   ├── auth.py           # OAuth endpoints
│   │   │   ├── devices.py        # Device management
│   │   │   ├── search.py         # Search tracks/artists
│   │   │   └── playlists.py      # Playlist management
│   │   └── dependencies.py       # Dependency injection
│   ├── application/
│   │   ├── commands/             # AuthenticateUser, RefreshToken
│   │   ├── queries/              # GetDevices, SearchTracks
│   │   ├── handlers/             # Command & Event handlers
│   │   └── services/             # SpotifyService, TokenService
│   ├── domain/
│   │   ├── entities/             # SpotifyUser, SpotifyToken, SpotifyDevice
│   │   ├── value_objects/        # SpotifyURI, AudioFeatures
│   │   ├── repositories/         # Repository interfaces
│   │   └── events/               # Domain events
│   ├── infrastructure/
│   │   ├── spotify/              # Spotify API client (spotipy wrapper)
│   │   ├── persistence/          # SQLAlchemy models & repos
│   │   ├── pubsub/               # Cloud Pub/Sub publisher
│   │   ├── secrets/              # Secret Manager integration
│   │   └── config/               # Settings, environment vars
│   └── main.py                   # FastAPI app entry point
└── tests/
    ├── unit/                     # Domain logic tests
    ├── integration/              # API integration tests
    └── mocks/                    # Spotify API mocks
```

## Patrones Implementados

- **CQRS**: Separación de Commands y Queries
- **Repository Pattern**: Abstracción de persistencia
- **Adapter Pattern**: Wrapper de spotipy para abstraer Spotify API
- **Circuit Breaker**: Para llamadas a Spotify API
- **Retry with Exponential Backoff**: Para errores transitorios

## Configuración

### Environment Variables
```env
SPOTIFY_CLIENT_ID=<from Spotify Developer Dashboard>
SPOTIFY_CLIENT_SECRET=<stored in Secret Manager>
SPOTIFY_REDIRECT_URI=https://yourdomain.com/callback
GCP_PROJECT_ID=your-gcp-project
PUBSUB_TOPIC_PREFIX=spotify-dj-remote
DATABASE_URL=postgresql://user:pass@cloud-sql-instance/spotify_integration_db
```

### OAuth Scopes Required
```python
SCOPES = [
    "user-read-playback-state",
    "user-modify-playback-state",
    "user-read-currently-playing",
    "user-read-recently-played",
    "playlist-read-private",
    "playlist-read-collaborative"
]
```

### Health Checks
- `/health`: Health check general
- `/health/ready`: Readiness probe (DB + Spotify API reachable)
- `/health/live`: Liveness probe

## Consideraciones Importantes

### Seguridad
- **Nunca** loggear access tokens o refresh tokens en plain text
- Encriptar tokens antes de almacenar en DB
- Usar HTTPS para todos los endpoints
- Validar redirect URI en OAuth para prevenir CSRF
- Implementar PKCE (Proof Key for Code Exchange) en OAuth flow

### Idempotencia
- Renovación de token es idempotente (mismo token si aún válido)
- Event handlers usan message ID para deduplicación

### Resiliencia
- Circuit breaker: Abre después de 5 fallos consecutivos a Spotify API
- Retry policy: Hasta 3 reintentos con backoff exponencial (1s, 2s, 4s)
- Timeout: 10 segundos por request a Spotify
- Fallback: Si Spotify API down, servir datos desde caché (stale data ok)

### Rate Limiting
- Implementar rate limiter local (Redis) para 180 req/min/user
- Priority queue para requests críticos (token refresh > search)
- Batching de requests cuando posible (audio features para múltiples tracks)

### Logging
- Structured logging con correlationId
- Log de todos los eventos publicados/consumidos
- Log de errores de Spotify API con detalles (status code, error message)
- **No** loggear tokens ni credentials

### Performance
- Caché de dispositivos (TTL: 30 segundos)
- Caché de playlists (TTL: 5 minutos)
- Caché de audio features (TTL: 24 horas, raramente cambian)
- Índices en userId, spotifyUserId, expiresAt

## Testing

### Unit Tests
- Token refresh logic
- OAuth flow validation
- Rate limiting logic
- Encryption/decryption de tokens

### Integration Tests
- OAuth complete flow (with mock Spotify)
- Token refresh automation
- Event publishing to Pub/Sub
- Database persistence

### Contract Tests
- Event schema validation
- Spotify API response parsing (usar fixtures reales)

## Endpoints API

### POST /api/auth/login
Inicia flujo OAuth con Spotify
- Genera authorization URL
- Retorna redirect URL con state parameter

### GET /api/auth/callback
Callback de OAuth
- Intercambia code por access token
- Almacena tokens en Secret Manager
- Publica UserAuthenticatedEvent

### POST /api/auth/logout
Revoca tokens y desautentica
- Elimina tokens de Secret Manager
- Publica UserLoggedOutEvent

### GET /api/auth/status
Estado de autenticación del usuario
- Valida si token es válido
- Retorna info básica del usuario

### GET /api/devices
Lista dispositivos Spotify disponibles
- Consulta Spotify API
- Actualiza caché
- Publica DevicesUpdatedEvent

### GET /api/search
Busca tracks, artists, albums
- Query params: q, type, limit
- Retorna resultados paginados

### GET /api/tracks/{id}/features
Obtiene audio features (BPM, key, energy)
- Caché agresivo (24h TTL)
- Fallback a metadata básica si no disponible

## Métricas y Observabilidad

- Contador de autenticaciones exitosas/fallidas
- Contador de tokens renovados
- Latencia de llamadas a Spotify API
- Tasa de errores de Spotify API (por endpoint)
- Rate limit usage (requests/min)
- Circuit breaker state changes
- Caché hit/miss ratio

## Referencias

- [ADR-007: GCP as Cloud Platform](../../docs/adr/007-gcp-cloud-platform.md)
- [ADR-008: Spotify API Integration](../../docs/adr/008-spotify-api-integration.md)
- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Spotify Web API Docs](https://developer.spotify.com/documentation/web-api)
