# Spotify Integration API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **gestionar toda la integraciÃ³n con Spotify Web API**, incluyendo autenticaciÃ³n OAuth, gestiÃ³n de tokens, y comunicaciÃ³n con endpoints de Spotify.

## Dominio

### Entidades Principales
- **SpotifyUser**: Usuario autenticado con Spotify Premium
- **SpotifyToken**: Access token y refresh token de OAuth
- **SpotifyDevice**: Dispositivos Spotify disponibles para reproducciÃ³n
- **SpotifyTrack**: Metadata de tracks (ID, URI, nombre, artista, Ã¡lbum, duraciÃ³n)
- **SpotifyPlaylist**: Playlists del usuario

### Agregados
- SpotifyUser (raÃ­z del agregado)
  - SpotifyTokens (parte del agregado)
  - SpotifyDevices (colecciÃ³n)
  - SpotifyPreferences (configuraciÃ³n)

## Responsabilidades

### Commands (Escritura)
- Autenticar usuario con Spotify OAuth 2.0
- Renovar tokens expirados
- Desautenticar usuario (revoke tokens)
- Actualizar preferencias de usuario

### Queries (Lectura)
- Obtener dispositivos disponibles del usuario
- Buscar tracks, artistas, Ã¡lbumes
- Obtener playlists del usuario
- Obtener metadata de track (BPM, key, audio features)
- Obtener estado de autenticaciÃ³n del usuario

## Eventos

### Eventos Publicados

#### UserAuthenticatedEvent
**CuÃ¡ndo**: Usuario completa autenticaciÃ³n OAuth con Spotify
**Payload**:
```json
{
  "userId": "string",
  "spotifyUserId": "string",
  "accessToken": "encrypted_string",
  "refreshToken": "encrypted_string",
  "expiresAt": "ISO8601",
  "scopes": ["user-read-playback-state", "user-modify-playback-state"],
  "authenticatedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API, Sync Service

#### TokenRefreshedEvent
**CuÃ¡ndo**: Access token es renovado automÃ¡ticamente
**Payload**:
```json
{
  "userId": "string",
  "newAccessToken": "encrypted_string",
  "expiresAt": "ISO8601",
  "refreshedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API

#### AuthenticationFailedEvent
**CuÃ¡ndo**: AutenticaciÃ³n o renovaciÃ³n de token falla
**Payload**:
```json
{
  "userId": "string",
  "errorCode": "string",
  "errorMessage": "string",
  "failedAt": "ISO8601"
}
```
**Consumidores**: Frontend, Sync Service

#### DevicesUpdatedEvent
**CuÃ¡ndo**: Lista de dispositivos Spotify cambia
**Payload**:
```json
{
  "userId": "string",
  "devices": [
    {
      "id": "string",
      "name": "string",
      "type": "Computer|Smartphone|Speaker|TV|etc",
      "isActive": "boolean",
      "volume": "number"
    }
  ],
  "updatedAt": "ISO8601"
}
```
**Consumidores**: Playback Control API, Frontend

### Eventos Consumidos

#### PlaybackCommandEvent (de Playback Control API)
**AcciÃ³n**: Ejecutar comando de reproducciÃ³n en Spotify API
**Handler**: PlaybackCommandHandler

#### DeviceRefreshRequestedEvent (de Frontend o Playback Control API)
**AcciÃ³n**: Actualizar lista de dispositivos desde Spotify
**Handler**: DeviceRefreshHandler

## Reglas de Negocio

1. Solo usuarios con Spotify Premium pueden autenticarse (validar en OAuth)
2. Tokens deben renovarse automÃ¡ticamente 5 minutos antes de expiraciÃ³n
3. MÃ¡ximo 3 reintentos para renovaciÃ³n de token antes de requerir re-autenticaciÃ³n
4. Todos los tokens se almacenan encriptados en GCP Secret Manager
5. Rate limiting: Respetar lÃ­mite de 180 requests/min/user de Spotify
6. Si usuario revoca acceso en Spotify, eliminar tokens localmente

## Dependencias Externas

### Base de Datos
- **Cloud SQL (PostgreSQL)**: SpotifyIntegrationDB
- Tablas: spotify_users, spotify_tokens, spotify_devices, token_refresh_log

### Spotify Web API
- **OAuth 2.0 Endpoints**:
  - Authorization: `https://accounts.spotify.com/authorize`
  - Token: `https://accounts.spotify.com/api/token`
- **API Endpoints**:
  - Devices: `GET /v1/me/player/devices`
  - Search: `GET /v1/search`
  - Audio Features: `GET /v1/audio-features/{id}`
  - Playlists: `GET /v1/users/{user_id}/playlists`

### GCP Services
- **Secret Manager**: Almacenamiento seguro de tokens
- **Cloud Pub/Sub**: PublicaciÃ³n de eventos
- **Cloud Logging**: Structured logging

### Bibliotecas
- **spotipy**: Wrapper de Spotify Web API
- **google-cloud-secret-manager**: GestiÃ³n de secrets
- **google-cloud-pubsub**: Event publishing

## Estructura del Proyecto

```
spotify-integration-api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ routers/              # FastAPI routers
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py           # OAuth endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ devices.py        # Device management
â”‚   â”‚   â”‚   â”œâ”€â”€ search.py         # Search tracks/artists
â”‚   â”‚   â”‚   â””â”€â”€ playlists.py      # Playlist management
â”‚   â”‚   â””â”€â”€ dependencies.py       # Dependency injection
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”œâ”€â”€ commands/             # AuthenticateUser, RefreshToken
â”‚   â”‚   â”œâ”€â”€ queries/              # GetDevices, SearchTracks
â”‚   â”‚   â”œâ”€â”€ handlers/             # Command & Event handlers
â”‚   â”‚   â””â”€â”€ services/             # SpotifyService, TokenService
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/             # SpotifyUser, SpotifyToken, SpotifyDevice
â”‚   â”‚   â”œâ”€â”€ value_objects/        # SpotifyURI, AudioFeatures
â”‚   â”‚   â”œâ”€â”€ repositories/         # Repository interfaces
â”‚   â”‚   â””â”€â”€ events/               # Domain events
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ spotify/              # Spotify API client (spotipy wrapper)
â”‚   â”‚   â”œâ”€â”€ persistence/          # SQLAlchemy models & repos
â”‚   â”‚   â”œâ”€â”€ pubsub/               # Cloud Pub/Sub publisher
â”‚   â”‚   â”œâ”€â”€ secrets/              # Secret Manager integration
â”‚   â”‚   â””â”€â”€ config/               # Settings, environment vars
â”‚   â””â”€â”€ main.py                   # FastAPI app entry point
â””â”€â”€ tests/
    â”œâ”€â”€ unit/                     # Domain logic tests
    â”œâ”€â”€ integration/              # API integration tests
    â””â”€â”€ mocks/                    # Spotify API mocks
```

## Patrones Implementados

- **CQRS**: SeparaciÃ³n de Commands y Queries
- **Repository Pattern**: AbstracciÃ³n de persistencia
- **Adapter Pattern**: Wrapper de spotipy para abstraer Spotify API
- **Circuit Breaker**: Para llamadas a Spotify API
- **Retry with Exponential Backoff**: Para errores transitorios

## ConfiguraciÃ³n

### Environment Variables
```env
SPOTIFY_CLIENT_ID=<from Spotify Developer Dashboard>
SPOTIFY_CLIENT_SECRET=<stored in Secret Manager>
SPOTIFY_REDIRECT_URI=https://yourdomain.com/callback
GCP_PROJECT_ID=your-gcp-project
PUBSUB_TOPIC_PREFIX=spotify-dj-remote
DATABASE_URL=postgresql://user:pass@cloud-sql-instance/spotify_integration_db
```

### OAuth Scopes Required
```python
SCOPES = [
    "user-read-playback-state",
    "user-modify-playback-state",
    "user-read-currently-playing",
    "user-read-recently-played",
    "playlist-read-private",
    "playlist-read-collaborative"
]
```

### Health Checks
- `/health`: Health check general
- `/health/ready`: Readiness probe (DB + Spotify API reachable)
- `/health/live`: Liveness probe

## Consideraciones Importantes

### Seguridad
- **Nunca** loggear access tokens o refresh tokens en plain text
- Encriptar tokens antes de almacenar en DB
- Usar HTTPS para todos los endpoints
- Validar redirect URI en OAuth para prevenir CSRF
- Implementar PKCE (Proof Key for Code Exchange) en OAuth flow

### Idempotencia
- RenovaciÃ³n de token es idempotente (mismo token si aÃºn vÃ¡lido)
- Event handlers usan message ID para deduplicaciÃ³n

### Resiliencia
- Circuit breaker: Abre despuÃ©s de 5 fallos consecutivos a Spotify API
- Retry policy: Hasta 3 reintentos con backoff exponencial (1s, 2s, 4s)
- Timeout: 10 segundos por request a Spotify
- Fallback: Si Spotify API down, servir datos desde cachÃ© (stale data ok)

### Rate Limiting
- Implementar rate limiter local (Redis) para 180 req/min/user
- Priority queue para requests crÃ­ticos (token refresh > search)
- Batching de requests cuando posible (audio features para mÃºltiples tracks)

### Logging
- Structured logging con correlationId
- Log de todos los eventos publicados/consumidos
- Log de errores de Spotify API con detalles (status code, error message)
- **No** loggear tokens ni credentials

### Performance
- CachÃ© de dispositivos (TTL: 30 segundos)
- CachÃ© de playlists (TTL: 5 minutos)
- CachÃ© de audio features (TTL: 24 horas, raramente cambian)
- Ãndices en userId, spotifyUserId, expiresAt

## Testing

### Unit Tests
- Token refresh logic
- OAuth flow validation
- Rate limiting logic
- Encryption/decryption de tokens

### Integration Tests
- OAuth complete flow (with mock Spotify)
- Token refresh automation
- Event publishing to Pub/Sub
- Database persistence

### Contract Tests
- Event schema validation
- Spotify API response parsing (usar fixtures reales)

## Endpoints API

### POST /api/auth/login
Inicia flujo OAuth con Spotify
- Genera authorization URL
- Retorna redirect URL con state parameter

### GET /api/auth/callback
Callback de OAuth
- Intercambia code por access token
- Almacena tokens en Secret Manager
- Publica UserAuthenticatedEvent

### POST /api/auth/logout
Revoca tokens y desautentica
- Elimina tokens de Secret Manager
- Publica UserLoggedOutEvent

### GET /api/auth/status
Estado de autenticaciÃ³n del usuario
- Valida si token es vÃ¡lido
- Retorna info bÃ¡sica del usuario

### GET /api/devices
Lista dispositivos Spotify disponibles
- Consulta Spotify API
- Actualiza cachÃ©
- Publica DevicesUpdatedEvent

### GET /api/search
Busca tracks, artists, albums
- Query params: q, type, limit
- Retorna resultados paginados

### GET /api/tracks/{id}/features
Obtiene audio features (BPM, key, energy)
- CachÃ© agresivo (24h TTL)
- Fallback a metadata bÃ¡sica si no disponible

## MÃ©tricas y Observabilidad

### ðŸ” Observabilidad Obligatoria

Este servicio **DEBE** implementar observabilidad completa siguiendo [ADR-010: Observability-First Architecture](../../docs/adr/010-observability-first-architecture.md).

#### Stack de Observabilidad
- **OpenTelemetry SDK**: Para traces, metrics y logs
- **Prometheus**: Para recolecciÃ³n de mÃ©tricas (endpoint `/metrics`)
- **Grafana**: Dashboard de visualizaciÃ³n
- **Jaeger**: Distributed tracing
- **Loki**: Log aggregation

#### InstrumentaciÃ³n Obligatoria

##### 1. Traces (OpenTelemetry)
Todos los endpoints y operaciones crÃ­ticas deben tener spans:

```python
@tracer.start_as_current_span("authenticate_user")
async def authenticate_user(code: str):
    span = trace.get_current_span()
    span.set_attribute("auth.code_length", len(code))
    # Business logic
```

**Spans requeridos**:
- HTTP request/response (automÃ¡tico con FastAPI instrumentor)
- Spotify API calls
- Database queries
- Event publishing
- Token refresh operations
- Cache operations

##### 2. Metrics (Prometheus)

**RED Metrics** (obligatorio):
- `http_requests_total{method, endpoint, status}` - Counter de requests
- `http_request_duration_seconds{method, endpoint}` - Histogram de latencia
- `http_requests_in_progress{method, endpoint}` - Gauge de requests activos

**Service-Specific Metrics**:
- `spotify_api_calls_total{endpoint, status}` - Llamadas a Spotify API
- `spotify_api_duration_seconds{endpoint}` - Latencia de Spotify API
- `spotify_auth_success_total` - Autenticaciones exitosas
- `spotify_auth_failed_total{reason}` - Autenticaciones fallidas
- `spotify_token_refreshed_total` - Tokens renovados
- `spotify_rate_limit_usage` - Usage de rate limit
- `spotify_cache_hits_total` - Cache hits
- `spotify_cache_misses_total` - Cache misses

**Circuit Breaker Metrics**:
- `circuit_breaker_state{name}` - Estado del circuit breaker
- `circuit_breaker_calls_total{name, result}` - Llamadas por estado

**Event Metrics**:
- `events_published_total{event_type, status}` - Eventos publicados
- `event_publishing_duration_seconds{event_type}` - Latencia de publicaciÃ³n

##### 3. Logs Estructurados

Formato JSON obligatorio con campos estÃ¡ndar:

```python
logger.info(
    "user_authenticated",
    user_id=user_id,
    spotify_user_id=spotify_user_id,
    correlation_id=correlation_id,
    trace_id=trace.get_current_span().get_span_context().trace_id,
    span_id=trace.get_current_span().get_span_context().span_id,
    duration_ms=duration
)
```

**Campos Obligatorios**:
- `timestamp` (ISO 8601)
- `level` (debug, info, warning, error, critical)
- `service` ("spotify-integration-api")
- `correlation_id`
- `trace_id`
- `span_id`
- `message` (snake_case)

**Eventos a Loguear**:
- `user_authentication_started`
- `user_authenticated`
- `user_authentication_failed`
- `token_refresh_started`
- `token_refreshed`
- `token_refresh_failed`
- `spotify_api_call_started`
- `spotify_api_call_completed`
- `spotify_api_call_failed`
- `event_published`
- `event_publishing_failed`

##### 4. Dashboards (Grafana)

Dashboard obligatorio: **"Spotify Integration API - Service Overview"**

**Paneles requeridos**:
1. Request Rate (req/s)
2. Error Rate (%)
3. Latency (P50, P95, P99)
4. Spotify API Call Rate
5. Spotify API Latency
6. Authentication Success/Failure Rate
7. Token Refresh Rate
8. Circuit Breaker Status
9. Cache Hit Ratio
10. Event Publishing Rate

##### 5. Alertas (Prometheus)

**Alertas obligatorias**:

```yaml
- alert: HighErrorRate
  expr: rate(http_requests_total{service="spotify-integration-api",status="error"}[5m]) / rate(http_requests_total{service="spotify-integration-api"}[5m]) > 0.05
  for: 5m
  
- alert: HighLatency
  expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service="spotify-integration-api"}[5m])) > 1.0
  for: 5m

- alert: SpotifyAPIHighFailureRate
  expr: rate(spotify_api_calls_total{status="error"}[5m]) / rate(spotify_api_calls_total[5m]) > 0.10
  for: 5m

- alert: TokenRefreshFailures
  expr: rate(spotify_token_refreshed_total{status="failed"}[5m]) > 0
  for: 2m
```

#### Contexto de PropagaciÃ³n

**Obligatorio**: Propagar trace context en:
- Headers HTTP salientes (a Spotify API): `traceparent`, `tracestate`
- Eventos publicados: incluir `trace_context` en payload
- Logs: vincular con `trace_id` y `span_id`

#### Health Check

Endpoint `/health` debe verificar:
- Database connectivity
- Pub/Sub connectivity
- Cache (Redis/Memorystore) connectivity
- Spotify API accessibility (con timeout corto)

Formato de respuesta:
```json
{
  "status": "healthy",
  "service": "spotify-integration-api",
  "version": "1.0.0",
  "checks": {
    "database": "healthy",
    "pubsub": "healthy",
    "cache": "healthy",
    "spotify_api": "healthy"
  },
  "timestamp": "2025-11-14T22:05:36.209Z"
}
```

#### Testing de Observabilidad

**Tests obligatorios**:
- âœ… Unit tests para emisiÃ³n de mÃ©tricas
- âœ… Unit tests para creaciÃ³n de spans
- âœ… Unit tests para formato de logs estructurados
- âœ… Integration tests para propagaciÃ³n de trace context
- âœ… Integration tests para health check

Ver [Observability Best Practices Guide](../../docs/guides/observability-best-practices.md) para ejemplos de tests.

#### Criterio de Completitud

Este servicio solo se considera **COMPLETO** cuando:
- [x] OpenTelemetry SDK integrado
- [x] Todos los endpoints instrumentados con traces
- [x] RED metrics + service-specific metrics expuestas
- [x] Logs estructurados con trace context
- [x] Dashboard creado en Grafana
- [x] Alertas configuradas en Prometheus
- [x] Health check implementado
- [x] Tests de observabilidad pasando
- [x] DocumentaciÃ³n de mÃ©tricas actualizada
- [x] **API Documentation completa**:
  - OpenAPI/Swagger accesible en `/docs` y `/redoc`
  - Todos los endpoints con docstrings descriptivos
  - Modelos Pydantic con descriptions y ejemplos
  - Tags para agrupar endpoints relacionados

---

## Referencias

- [ADR-007: GCP as Cloud Platform](../../docs/adr/007-gcp-cloud-platform.md)
- [ADR-008: Spotify API Integration](../../docs/adr/008-spotify-api-integration.md)
- [ADR-010: Observability-First Architecture](../../docs/adr/010-observability-first-architecture.md)
- [Observability Best Practices](../../docs/guides/observability-best-practices.md)
- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Spotify Web API Docs](https://developer.spotify.com/documentation/web-api)
