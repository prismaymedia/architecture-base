# Payments API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **procesar pagos y gestionar transacciones financieras** en el sistema de e-commerce.

## Dominio

### Entidades Principales
- **Payment**: Representa una transacción de pago
- **PaymentMethod**: Métodos de pago disponibles (tarjeta, PayPal, etc.)
- **Transaction**: Detalle de cada intento de transacción
- **Refund**: Reembolsos procesados

### Agregados
- Payment (raíz del agregado)
  - Transactions (historial de intentos)
  - Refund (si aplica)

## Responsabilidades

### Commands (Escritura)
- Procesar pago
- Autorizar pago
- Capturar pago
- Procesar reembolso
- Cancelar autorización
- Guardar método de pago

### Queries (Lectura)
- Consultar estado de pago
- Obtener historial de transacciones
- Listar métodos de pago de un cliente
- Consultar detalles de reembolso

## Eventos

### Eventos Publicados

#### PaymentApprovedEvent
**Cuándo**: Cuando el pago es procesado exitosamente
**Payload**:
```
- PaymentId: Guid
- OrderId: Guid
- Amount: decimal
- Currency: string
- PaymentMethod: string
- TransactionId: string (de la pasarela)
- ProcessedAt: DateTime
```
**Consumidores**: Orders API, Notifications API

#### PaymentRejectedEvent
**Cuándo**: Cuando el pago falla o es rechazado
**Payload**:
```
- PaymentId: Guid
- OrderId: Guid
- Reason: string
- ErrorCode: string
- RejectedAt: DateTime
```
**Consumidores**: Orders API, Inventory API, Notifications API

#### PaymentPendingEvent
**Cuándo**: Cuando el pago está en proceso (ej: transferencia bancaria)
**Payload**:
```
- PaymentId: Guid
- OrderId: Guid
- ExpectedCompletionDate: DateTime
- PendingAt: DateTime
```
**Consumidores**: Orders API, Notifications API

#### RefundProcessedEvent
**Cuándo**: Cuando se procesa un reembolso exitosamente
**Payload**:
```
- RefundId: Guid
- PaymentId: Guid
- OrderId: Guid
- Amount: decimal
- ProcessedAt: DateTime
```
**Consumidores**: Orders API, Notifications API

#### RefundFailedEvent
**Cuándo**: Cuando falla el procesamiento de un reembolso
**Payload**:
```
- RefundId: Guid
- PaymentId: Guid
- OrderId: Guid
- Reason: string
- FailedAt: DateTime
```
**Consumidores**: Notifications API (para alertar soporte)

### Eventos Consumidos

#### OrderCreatedEvent (de Orders API)
**Acción**: Iniciar proceso de pago
**Handler**: OrderCreatedEventHandler
**Flujo**:
1. Validar método de pago
2. Procesar pago con la pasarela
3. Si exitoso: Publicar PaymentApprovedEvent
4. Si falla: Publicar PaymentRejectedEvent

#### OrderCancelledEvent (de Orders API)
**Acción**: Procesar reembolso automático si ya se había pagado
**Handler**: OrderCancelledEventHandler

#### InventoryReservationFailedEvent (de Inventory API)
**Acción**: Cancelar autorización de pago o procesar reembolso
**Handler**: InventoryReservationFailedEventHandler

## Reglas de Negocio

1. Un pago no puede procesarse dos veces (idempotencia)
2. Los reembolsos pueden ser parciales o totales
3. Un reembolso no puede exceder el monto original
4. Los datos de tarjetas se tokenizan, nunca se almacenan en claro
5. Timeout de 30 segundos para llamadas a pasarelas de pago
6. Máximo 3 reintentos automáticos en caso de error temporal
7. Solo se pueden reembolsar pagos en estado "Approved"

## Dependencias Externas

### Base de Datos
- **PaymentsDB** (SQL Server)
- Tablas: Payments, Transactions, PaymentMethods, Refunds

### Event Bus
- RabbitMQ / Azure Service Bus

### Payment Gateways (Integraciones Externas)
- Stripe API
- PayPal API
- Authorize.Net
- (Patrón Strategy para múltiples gateways)

### PCI Compliance
- Tokenización de tarjetas via vault externo
- No almacenar CVV
- Encriptación de datos sensibles

## Estructura del Proyecto

```
payments-api/
├── src/
│   ├── api/
│   │   ├── Controllers/         # Endpoints REST
│   │   ├── Webhooks/            # Webhooks de gateways
│   │   └── Middleware/
│   ├── application/
│   │   ├── Commands/            # Process, Refund commands
│   │   ├── Queries/             # Payment status queries
│   │   ├── Handlers/            # Command & Event handlers
│   │   └── Services/            # PaymentService, RefundService
│   ├── domain/
│   │   ├── Entities/            # Payment, Transaction, Refund
│   │   ├── ValueObjects/        # Money, PaymentStatus
│   │   ├── Repositories/        # Interfaces
│   │   └── Events/              # Domain events
│   └── infrastructure/
│       ├── Persistence/         # EF Core DbContext
│       ├── EventBus/            # Event publishing/consuming
│       ├── Gateways/            # Stripe, PayPal adapters
│       │   ├── IPaymentGateway.cs
│       │   ├── StripeGateway.cs
│       │   └── PayPalGateway.cs
│       └── Configuration/
└── tests/
    ├── unit/
    ├── integration/
    └── fixtures/
```

## Patrones Implementados

- **Strategy Pattern**: Para múltiples gateways de pago
- **CQRS**: Separación de Commands y Queries
- **Saga Participant**: Participa en Saga de creación de orden
- **Circuit Breaker**: Para llamadas a gateways externos
- **Retry Pattern**: Con exponential backoff

## Configuración

### Connection Strings
- PaymentsDB: Conexión a SQL Server

### Event Bus Settings
- Queue names: `payments.*`
- Exchange: `payments-exchange`

### Payment Gateway Settings
```
Stripe:
  - ApiKey: (secret)
  - WebhookSecret: (secret)
  - Timeout: 30s

PayPal:
  - ClientId: (secret)
  - ClientSecret: (secret)
  - Mode: sandbox/live
```

### Circuit Breaker
- Failure threshold: 5 fallos consecutivos
- Timeout: 30 segundos
- Recovery time: 60 segundos

## Consideraciones Importantes

### Seguridad
- Todos los datos sensibles se encriptan
- PCI DSS compliance
- Tokenización de tarjetas
- HTTPS obligatorio
- API keys en Azure Key Vault
- Auditoría completa de todas las transacciones

### Idempotencia
- Usar OrderId + timestamp como idempotency key
- Verificar si ya existe pago para ese OrderId
- Retornar el resultado existente si ya se procesó

### Resiliencia
- Circuit breaker para cada gateway
- Retry con exponential backoff (1s, 2s, 4s)
- Fallback: Marcar como "Pending" y procesar async
- Dead letter queue para pagos fallidos

### Transacciones
- Usar compensating transactions (reembolsos)
- Nunca hacer rollback de pagos exitosos
- Logging exhaustivo de cada paso

### Performance
- Caché de payment methods del cliente
- Async processing para webhooks
- Rate limiting para proteger gateway quotas

## Testing

### Unit Tests
- Business rules validation
- Payment calculation logic
- Strategy pattern implementation

### Integration Tests
- Full payment flow
- Event handler integration
- Gateway mocking

### Contract Tests
- Webhook signature validation
- Event schema validation

### Security Tests
- PCI compliance tests
- Encryption validation

## Endpoints API

### POST /api/payments
Procesar pago (llamado internamente via eventos)

### GET /api/payments/{id}
Consultar estado de pago

### POST /api/payments/{id}/refund
Procesar reembolso

### POST /api/webhooks/stripe
Webhook de Stripe para actualización de estado

### POST /api/webhooks/paypal
Webhook de PayPal

### GET /api/payments/methods
Listar métodos de pago del cliente

### POST /api/payments/methods
Guardar nuevo método de pago (tokenizado)

## Webhooks

### Stripe Webhook
- Eventos: `payment_intent.succeeded`, `payment_intent.failed`
- Validación: Verificar firma del webhook
- Acción: Actualizar estado de pago, publicar eventos

### PayPal Webhook
- Eventos: `PAYMENT.CAPTURE.COMPLETED`, `PAYMENT.CAPTURE.DENIED`
- Validación: Verificar certificado
- Acción: Actualizar estado de pago, publicar eventos

## Métricas y Observabilidad

- Tasa de aprobación de pagos
- Tasa de rechazo por motivo
- Latencia de procesamiento por gateway
- Monto total procesado
- Tasa de reembolsos
- Disponibilidad de gateways
- Errores por tipo

## Escenarios de Compensación

### Saga Compensación: Inventory Reservation Failed

```
1. Payment procesó cargo exitosamente
2. Inventory no tiene stock
3. Payments recibe InventoryReservationFailedEvent
4. Procesa reembolso automático
5. Publica RefundProcessedEvent
```

### Timeout de Gateway

```
1. Llamada a gateway timeout después de 30s
2. Marcar payment como "Pending"
3. Background job consulta estado cada 5 minutos
4. Cuando resuelve, publicar evento correspondiente
```

## Alertas Críticas

- Tasa de rechazo > 20%
- Gateway no responde
- Fallo en procesamiento de reembolso
- Webhooks no siendo recibidos
- Discrepancia entre nuestro estado y estado del gateway

## Cumplimiento

- **PCI DSS**: Nivel 1 compliant
- **GDPR**: Datos de pago anonimizados después de 7 años
- **SOX**: Auditoría de todas las transacciones financieras
- **ISO 27001**: Seguridad de la información

## Referencias

- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Saga Pattern Guide](../../docs/guides/saga-pattern.md)
- [Security Guidelines](../../docs/guides/security.md)
- [PCI Compliance](../../docs/guides/pci-compliance.md)
