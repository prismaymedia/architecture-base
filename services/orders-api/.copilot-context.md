# Orders API - Contexto de Copilot

## Responsabilidad del Servicio

Este microservicio es responsable de **gestionar el ciclo de vida completo de pedidos** en el sistema de e-commerce.

## Dominio

### Entidades Principales
- **Order**: Representa un pedido completo
- **OrderItem**: Líneas individuales del pedido
- **OrderStatus**: Estados del pedido (Pending, Confirmed, Shipped, Cancelled, etc.)

### Agregados
- Order (raíz del agregado)
  - OrderItems (parte del agregado)
  - OrderAddress
  - OrderPaymentInfo

## Responsabilidades

### Commands (Escritura)
- Crear nuevo pedido
- Actualizar estado del pedido
- Cancelar pedido
- Agregar items al pedido
- Modificar información de envío

### Queries (Lectura)
- Obtener detalles de un pedido
- Listar pedidos de un cliente
- Buscar pedidos por criterios
- Obtener historial de estados

## Eventos

### Eventos Publicados

#### OrderCreatedEvent
**Cuándo**: Cuando se crea un nuevo pedido
**Payload**:
```
- OrderId: Guid
- CustomerId: Guid
- OrderDate: DateTime
- TotalAmount: decimal
- Items: List<OrderItem>
- ShippingAddress: Address
- CreatedAt: DateTime
```
**Consumidores**: Inventory API, Payments API, Notifications API

#### OrderConfirmedEvent
**Cuándo**: Cuando el pago es aprobado y se confirma el pedido
**Payload**:
```
- OrderId: Guid
- ConfirmedAt: DateTime
- EstimatedDeliveryDate: DateTime
```
**Consumidores**: Notifications API

#### OrderCancelledEvent
**Cuándo**: Cuando se cancela un pedido (por pago rechazado o solicitud del cliente)
**Payload**:
```
- OrderId: Guid
- CancellationReason: string
- CancelledAt: DateTime
```
**Consumidores**: Inventory API, Notifications API

#### OrderShippedEvent
**Cuándo**: Cuando el pedido es enviado
**Payload**:
```
- OrderId: Guid
- TrackingNumber: string
- Carrier: string
- ShippedAt: DateTime
```
**Consumidores**: Notifications API

### Eventos Consumidos

#### PaymentApprovedEvent (de Payments API)
**Acción**: Confirmar el pedido y cambiar estado a Confirmed
**Handler**: PaymentApprovedEventHandler

#### PaymentRejectedEvent (de Payments API)
**Acción**: Cancelar el pedido y cambiar estado a Cancelled
**Handler**: PaymentRejectedEventHandler

#### InventoryReservedEvent (de Inventory API)
**Acción**: Validar que hay stock disponible, proceder con el pedido
**Handler**: InventoryReservedEventHandler

#### InventoryReservationFailedEvent (de Inventory API)
**Acción**: Cancelar pedido por falta de stock
**Handler**: InventoryReservationFailedEventHandler

## Reglas de Negocio

1. Un pedido no puede ser modificado una vez confirmado
2. Solo se pueden cancelar pedidos en estado Pending o Confirmed
3. El monto total debe coincidir con la suma de los items
4. Cada pedido debe tener al menos un item
5. La dirección de envío es obligatoria
6. Un pedido cancelado no puede cambiar a otro estado

## Dependencias Externas

### Base de Datos
- **OrdersDB** (SQL Server)
- Tablas: Orders, OrderItems, OrderStatusHistory

### Event Bus
- RabbitMQ / Azure Service Bus para publicar/consumir eventos

### APIs Externas (Ninguna sincrónica)
- Toda comunicación es asíncrona mediante eventos

## Estructura del Proyecto

```
orders-api/
├── src/
│   ├── api/
│   │   ├── Controllers/         # Endpoints REST
│   │   └── Middleware/          # Middleware custom
│   ├── application/
│   │   ├── Commands/            # Create, Update, Cancel commands
│   │   ├── Queries/             # Queries para lectura
│   │   ├── Handlers/            # Command & Event handlers
│   │   └── Services/            # Application services
│   ├── domain/
│   │   ├── Entities/            # Order, OrderItem
│   │   ├── ValueObjects/        # Address, Money, OrderStatus
│   │   ├── Repositories/        # Interfaces de repositorios
│   │   └── Events/              # Domain events
│   └── infrastructure/
│       ├── Persistence/         # EF Core DbContext, Repositories
│       ├── EventBus/            # Event publishing/consuming
│       └── Configuration/       # Dependency injection
└── tests/
    ├── unit/                    # Unit tests
    ├── integration/             # Integration tests
    └── fixtures/                # Test data
```

## Patrones Implementados

- **CQRS**: Separación de Commands y Queries
- **Repository Pattern**: Abstracción de persistencia
- **Domain Events**: Eventos de dominio internos
- **Saga Participant**: Participa en Saga de creación de orden

## Configuración

### Connection Strings
- OrdersDB: Conexión a SQL Server

### Event Bus Settings
- RabbitMQ/Service Bus connection
- Queue names: `orders.*`
- Exchange: `orders-exchange`

### Health Checks
- `/health`: Health check general
- `/health/ready`: Readiness probe
- `/health/live`: Liveness probe

## Consideraciones Importantes

### Idempotencia
- Todos los event handlers deben ser idempotentes
- Usar MessageId para deduplicación
- Almacenar eventos procesados

### Resiliencia
- Circuit breaker para event publishing
- Retry policy con exponential backoff
- Dead letter queue para eventos fallidos

### Logging
- Structured logging con Serilog
- Correlation ID en todos los logs
- Logging de todos los eventos publicados/consumidos

### Performance
- Paginación en queries de listado
- Índices en OrderId, CustomerId, OrderDate
- Caché de queries frecuentes con Redis

## Testing

### Unit Tests
- Domain logic
- Business rules validation
- Value objects

### Integration Tests
- Event handlers
- Repository implementations
- Full saga flows

### Contract Tests
- Event schema validation
- Compatibility con consumidores

## Endpoints API

### POST /api/orders
Crear nuevo pedido
- Valida datos de entrada
- Publica OrderCreatedEvent

### GET /api/orders/{id}
Obtener detalles de pedido

### GET /api/orders
Listar pedidos (con filtros y paginación)

### PUT /api/orders/{id}/cancel
Cancelar pedido
- Solo si está en estado cancelable
- Publica OrderCancelledEvent

### GET /api/orders/{id}/history
Obtener historial de estados del pedido

## Métricas y Observabilidad

- Contador de órdenes creadas
- Contador de órdenes confirmadas
- Contador de órdenes canceladas
- Latencia de procesamiento de eventos
- Tasa de errores

## Referencias

- [Architecture Overview](../../docs/architecture/README.md)
- [Event Catalog](../../docs/events/README.md)
- [Saga Pattern Guide](../../docs/guides/saga-pattern.md)
